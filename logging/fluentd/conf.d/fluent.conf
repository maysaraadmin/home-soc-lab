# Global configuration
<system>
  log_level info
  root_dir /fluentd/log/
</system>

# Input plugins (sources)
<source>
  @type forward
  port 24224
  bind 0.0.0.0
  @label @INGRESS
</source>

<source>
  @type http
  port 9880
  bind 0.0.0.0
  @label @INGRESS
</source>

# Label @INGRESS
<label @INGRESS>
  # Parse JSON logs
  <filter **>
    @type parser
    key_name log
    remove_key_name_field true
    <parse>
      @type json
      time_key time
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
      keep_time_key true
    </parse>
  </filter>

  # Add Kubernetes metadata if available
  <filter **>
    @type record_transformer
    enable_ruby true
    <record>
      hostname ${hostname}
      service_name ${tag_parts[0]}
      log_level ${record.dig('log', 'level') || record.dig('level') || 'INFO'}
    </record>
  </filter>

  # Route to appropriate output
  <match **>
    @type copy
    <store>
      @type elasticsearch
      host elasticsearch
      port 9200
      logstash_format true
      logstash_prefix soc-logs
      logstash_dateformat %Y.%m.%d
      include_tag_key true
      type_name _doc
      tag_key @log_name
      flush_interval 5s
      <buffer>
        @type file
        path /fluentd/log/buffer/elasticsearch
        flush_thread_count 4
        flush_interval 5s
        chunk_limit_size 8MB
        total_limit_size 2GB
        overflow_action block
        retry_forever true
        retry_max_interval 30
      </buffer>
    </store>
    
    # Fallback to file if Elasticsearch is down
    <store>
      @type file
      path /fluentd/log/backup/logs
      append true
      <buffer>
        @type file
        path /fluentd/log/buffer/file
        timekey 1d
        timekey_wait 10m
        timekey_use_utc true
        chunk_limit_size 256MB
      </buffer>
    </store>
  </match>
</label>
